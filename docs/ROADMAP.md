# ROADMAP: переход на self-hosted инфраструктуру

Цель — минимизировать внешние SaaS-зависимости (кроме LLM-провайдера) и перенести ключевые сервисы на собственные сервера или кластер.

## Текущий внешний стек

- **Next.js 16 (App Router)** — фронтенд и серверные роуты. Деплой подразумевает Vercel.
- **Clerk** — аутентификация и управление пользователями.
- **Drizzle ORM + Neon** — доступ к управляемой PostgreSQL.
- **Amazon S3** — хранение изображений обложек.
- **Upstash Redis/RateLimit/Workflow/QStash** — хранение состояния пайплайна и оркестрация задач.
- **Together.ai + Helicone** — генерация и трассировка запросов к LLM.
- **Exa** — веб-поиск и получение контента страниц.
- **Plausible** — аналитика (через next-plausible).

## Self-hosted альтернативы

| Компонент | Текущее решение | Self-hosted замена | Ключевые действия |
| --- | --- | --- | --- |
| Хостинг Next.js | Vercel | Docker/Podman + Nginx/Traefik на VM или Kubernetes (K3s/MicroK8s) | Собрать `next build`, выкатывать контейнеры через CI/CD, настроить CDN/edge-кеш через Nginx.
| Аутентификация | Clerk | Keycloak или authentik | Настроить OIDC/SAML, заменить Clerk SDK на собственный OIDC клиент, мигрировать пользователей скриптом.
| База данных | Neon (Postgres) | Self-hosted PostgreSQL/Patroni (или TimescaleDB, если нужны тайм‑серии) | Поднять кластер, перенести данные через `pg_dump/pg_restore`, обновить `DATABASE_URL`.
| Объектное хранилище | Amazon S3 | MinIO или Ceph RGW | Развернуть S3-совместимое хранилище, создать bucket для обложек, обновить переменные `S3_UPLOAD_*`.
| Кэш/состояние | Upstash Redis | Redis/Valkey/Dragonfly на собственных нодах | Перенести данные, обновить соединение в `UPSTASH_REDIS_*`, настроить резервные копии и мониторинг.
| Оркестрация и очереди | Upstash Workflow/QStash | Temporal, BullMQ (Redis), или Apache Airflow + Celery | Заменить вызовы `workflow.trigger`/`qstash.publishJSON` на задачи/воркфлоу выбранной системы, добавить worker-сервис.
| Поиск в вебе | Exa | Самостоятельный краулер (Playwright/Puppeteer + chromium) + индекс (Meilisearch/Elasticsearch) | Реализовать сбор HTML, безопасный парсинг, дедупликацию и полнотекстовый поиск; добавить политику роботов и лимиты.
| Аналитика | Plausible (SaaS) | Self-hosted Plausible или Umami/Matomo | Развернуть аналитический сервис, переключить скрипт отслеживания на свой домен.
| LLM телеметрия | Helicone (прокси) | Langfuse или OpenTelemetry + Prometheus/Grafana | Запустить self-hosted мониторинг, переключить Together.ai клиента на собственный прокси/трэйсер.

## План миграции (итерациями)

1. **Инфраструктурный фундамент**: поднять Kubernetes/VM, настроить реверс-прокси и CI/CD для сборки контейнеров Next.js.
2. **Данные и файлы**: развернуть PostgreSQL и MinIO, перенести существующие данные и изменить переменные окружения.
3. **Состояние и очереди**: заменить Upstash Redis на собственный кластер; внедрить выбранную очередь/оркестратор (например, Temporal) и переписать вызовы планировщика.
4. **Аутентификация**: внедрить Keycloak/authentik, переключить фронтенд/бэкенд на OIDC, мигрировать пользователей.
5. **Поиск и сбор данных**: внедрить self-hosted краулер и индекс, постепенно выводя Exa из критического пути.
6. **Наблюдаемость и аналитика**: self-hosted Plausible/Umami для продукта, Langfuse/OTel для LLM-запросов и воркфлоу.
7. **Хостинг и отказоустойчивость**: нагрузочное тестирование, бэкапы, алерты, сценарии disaster recovery.

## Риски и проверки

- Производительность краулера и полнота поиска должны сопоставляться с Exa; потребуется контрольная выборка тем.
- Оркестратор обязан поддерживать повторные попытки и idempotency, аналогично Upstash Workflow/QStash.
- Оценить трудозатраты на поддержку самописной аутентификации и мониторинга (SLA vs. стоимость SaaS).
- Для Together.ai оставить внешний LLM, но маршрутизировать трафик через выбранный self-hosted трейсинг.
